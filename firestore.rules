rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    function isAuth() { return request.auth != null; }
    function isAdmin() { return isAuth() && getUserRole() == 'admin'; }
    function isSupervisor() { return isAuth() && getUserRole() in ['admin', 'supervisor']; }
    function isOperator() { return isAuth() && getUserRole() in ['admin', 'supervisor', 'operator']; }

    match /users/{userId} {
      allow read: if isAuth() && (request.auth.uid == userId || isSupervisor());
      allow write: if isAdmin();
      allow update: if request.auth.uid == userId &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'photoURL', 'preferences']);
    }
    match /plants/{plantId} { allow read: if isAuth(); allow write: if isAdmin(); }
    match /units/{unitId} { allow read: if isAuth(); allow create, update: if isSupervisor(); allow delete: if isAdmin(); }
    match /sensors/{sensorId} {
      allow read: if isAuth(); allow write: if isSupervisor();
      match /readings/{readingId} { allow read: if isAuth(); allow create: if true; }
    }
    match /cameras/{cameraId} { allow read: if isAuth(); allow write: if isAdmin(); }
    match /alerts/{alertId} { allow read: if isAuth(); allow create: if true; allow update: if isOperator(); }
    match /reports/{reportId} { allow read: if isSupervisor(); allow create: if isSupervisor(); allow update, delete: if isAdmin(); }
    match /dashboard_layouts/{layoutId} {
      allow read, write: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth();
    }
    match /audit_log/{logId} { allow read: if isAdmin(); allow create: if isAuth(); }
  }
}